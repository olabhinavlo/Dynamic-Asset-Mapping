//version-1.0.1
(() => {
  const BASE = "https://github.com/olabhinavlo/Dynamic-Asset-Mapping/blob/main/";
  const FORMATS = new Set(["png", "webp", "svg"]);
  const SIZES = {
    xs: 12,
    sm: 16,
    md: 24,
    lg: 36,
    xl: 48
  };
  const FALLBACK = "fallback.webp"; // default fallback image
  const CACHE = new Map();

  // Apply icon to a single element + class
  function apply(el, cls) {
    if (CACHE.has(cls)) {
      el.style.backgroundImage = CACHE.get(cls);
      return;
    }

    const parts = cls.split("_");
    if (parts.length < 3) return;

    const [format, category, name] = parts;
    if (!FORMATS.has(format)) return;

    // Build URL with folder structure
    const url = `${BASE}${category}/${format}/${name}.${format}`;
    const bg = `url(${url}), url(${BASE}${FALLBACK})`;

    CACHE.set(cls, bg);

    el.style.display = "inline-block";
    el.style.width = "24px";
    el.style.height = "24px";
    el.style.backgroundRepeat = "no-repeat";
    el.style.backgroundPosition = "center";
    el.style.backgroundSize = "contain";
    el.style.backgroundImage = bg;

    // Check for size class
    for (const size in SIZES) {
      if (el.classList.contains(`size-${size}`)) {
        el.style.width = SIZES[size] + "px";
        el.style.height = SIZES[size] + "px";
        break;
      }
    }

    // Preload main image
    const img = new Image();
    img.src = url;
  }

  // Scan container (or whole document)
  function scan(root = document) {
    const nodes = root.querySelectorAll("i");
    for (let i = 0; i < nodes.length; i++) {
      const el = nodes[i];
      for (let j = 0; j < el.classList.length; j++) {
        apply(el, el.classList[j]);
      }
    }
  }

  // Initial scan
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => scan());
  } else {
    scan();
  }

  // Observe dynamically added nodes
  new MutationObserver(mutations => {
    for (const mutation of mutations) {
      for (const node of mutation.addedNodes) {
        if (node.nodeType === 1) scan(node);
      }
    }
  }).observe(document.body, { childList: true, subtree: true });
})();
